#!/bin/bash -e

# Determine solution directory
if [ -n "$1" ]; then
    # Get the directory where the script is located
    REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && cd .. && pwd)"

    # Path provided as argument
    SOLUTION_DIR="$REPO_ROOT/$1"
else
    # No path provided, use current working directory
    SOLUTION_DIR="$(pwd)"
fi

# Resolve to absolute path
SOLUTION_DIR="$(cd "$SOLUTION_DIR" && pwd)"

# Check if main_test.go exists
if [ ! -f "$SOLUTION_DIR/main_test.go" ]; then
    echo "ERROR: main_test.go not found in $SOLUTION_DIR"
    exit 1
fi

# Run tests
cd "$SOLUTION_DIR"

# Run tests and colorize output
set +e
go test -v . 2>&1 | sed -E \
    -e "s/^=== RUN.*/$(printf '\033[36m')&$(printf '\033[0m')/" \
    -e "s/^[[:space:]]*--- PASS.*/$(printf '\033[32m')&$(printf '\033[0m')/" \
    -e "s/^[[:space:]]*--- FAIL.*/$(printf '\033[31m')&$(printf '\033[0m')/" \
    -e "s/^[[:space:]]*RESULT:.*/$(printf '\033[34m')&$(printf '\033[0m')/" \
    -e "s/^PASS$/$(printf '\033[32m')&$(printf '\033[0m')/" \
    -e "s/^FAIL.*/$(printf '\033[31m')&$(printf '\033[0m')/" \
    -e "s/^ok .*/$(printf '\033[32m')&$(printf '\033[0m')/"

exit ${PIPESTATUS[0]}